<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>Document</title>
</head>
<body>
<script>
    // 1. executor 执行器函数
    // 2. resolve 把promise变成成功态， reject把promise变成失败态
    // 3. value 记录成功的原因 reason 失败的原因
    // 4. promise 三种状态 1 pending准备态 2 fulfilled 完成态 3 rejected 拒绝态
    // 5. promise状态只能改变一次，pending==>fulfilled  pending==>rejected 不能完成态拒绝态相互转换
    // 6. promise执行过程中任何错误都会导致promise变成失败态
    // 7. promise必须有then方法 onFulfilled成功的回调函数, onRejected失败的回调函数
    const PENDING = 'pending'
    const FULFILLED = 'fulfilled'
    const REJECTED = 'rejected'

    class Promise {
        value
        reason
        status = PENDING
        onFulfilledCallBacks = []
        onRejectedCallBacks = []


        constructor(executor) {
            const resolve = (value) => {
                if (this.status === PENDING) {
                    this.value = value
                    this.status = FULFILLED
                    // this.onFulfilled(this.value)
                    this.onFulfilledCallBacks.forEach(cb => cb())
                }
            }
            const reject = (reason) => {
                if (this.status === PENDING) {
                    this.reason = reason
                    this.status = REJECTED
                    // this.onRejected(this.reason)
                    this.onRejectedCallBacks.forEach((cb => cb()))
                }
            }
            try {
                executor(resolve, reject)
            } catch (error) {
                reject(error)
            }
        }

        then(onFulfilled, onRejected) {
            if (this.status === FULFILLED) {
                onFulfilled(this.value)
            }

            if (this.status === REJECTED) {
                onRejected(this.reason)
            }
            if (this.status === PENDING) {
                // 异步订阅
                // this.onFulfilled = onFulfilled
                // this.onRejected = onRejected
                this.onFulfilledCallBacks.push(() => {
                    onFulfilled(this.value)
                })
                this.onRejectedCallBacks.push(() => {
                    onRejected(this.reason)
                })
            }
        }
    }

    // console.log(new Promise((resolve, reject) => {
    //     resolve()
    //     reject('失败')
    // }))

    // const p1 = new Promise(() => {
    // }) //Pending
    // const p2 = new Promise((resolve) => resolve()) // fulfilled
    // const p3 = new Promise((resolve, reject) => reject()) // rejected
    //
    // console.log(
    //     'p1', p1,
    //     'p2', p2,
    //     'p3', p3
    // )

    const p = new Promise((resolve, reject) => {
        // throw new Error()
        setTimeout(() => {
            reject('失败')
        }, 3000)
    })
    p.then(
        (res) => console.log(res),
        (err) => console.log(err)
    )
</script>
</body>
</html>
